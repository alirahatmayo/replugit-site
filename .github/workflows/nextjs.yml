# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["master"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Debug environment
        run: |
          echo "=== Environment Debug ==="
          pwd
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "=== Directory contents before build ==="
          ls -la
          echo "=== Package.json scripts ==="
          cat package.json | grep -A 10 '"scripts"'
          echo "=== Next.js config ==="
          cat next.config.ts
      
      - name: Build with detailed logging
        run: |
          echo "=== Starting build process ==="
          set -x  # Enable command tracing
          npm run build 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set +x  # Disable command tracing
          echo "=== Build exit code: $BUILD_EXIT_CODE ==="
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
            echo "=== Build log ==="
            cat build.log
            exit $BUILD_EXIT_CODE
          fi
          echo "✅ Build completed successfully"
      
      - name: Verify build output
        run: |
          echo "=== Post-build directory contents ==="
          ls -la
          echo "=== Looking for any 'out' directories recursively ==="
          find . -name "out" -type d 2>/dev/null || echo "No 'out' directories found"
          echo "=== Looking for any '.next' directories ==="
          find . -name ".next" -type d 2>/dev/null || echo "No '.next' directories found"
          echo "=== Contents of current directory ==="
          for item in *; do
            if [ -d "$item" ]; then
              echo "Directory: $item/"
              ls -la "$item/" | head -5
            else
              echo "File: $item"
            fi
          done
          
          # Try to find the actual build output
          if [ -d "out" ]; then
            echo "✅ Found out/ directory"
            ls -la out/
            echo "out/ contains $(ls out/ | wc -l) items"
          elif [ -d ".next" ]; then
            echo "⚠️ Found .next/ but no out/ - trying manual export"
            npx next export
            if [ -d "out" ]; then
              echo "✅ Manual export created out/ directory"
              ls -la out/
            else
              echo "❌ Manual export failed"
              exit 1
            fi
          else
            echo "❌ No build output found - build may have failed"
            echo "Trying alternative build methods..."
            
            # Try the export script
            echo "Trying npm run export..."
            npm run export || echo "Export script failed"
            
            if [ -d "out" ]; then
              echo "✅ Export script worked"
            else
              echo "Export script didn't create out/ directory"
              
              # Last resort - try deploy script
              echo "Trying npm run deploy..."
              npm run deploy || echo "Deploy script failed"
              
              if [ -d "out" ]; then
                echo "✅ Deploy script worked"
              else
                echo "❌ All methods failed"
                exit 1
              fi
            fi
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './out'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
